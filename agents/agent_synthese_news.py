"""\nAgent 2 - Synth√©tiseur News\nMod√®le : GPT-4o (qualit√© maximale)\nR√¥le : Lire JSON filtr√© ‚Üí G√©n√©rer synth√®se Markdown ‚Üí Upload Google Drive\nStructure : 6 sujets d√©taill√©s + autres sujets en bref\n"""\n\nimport os\nimport json\nimport sys\nimport traceback\nfrom datetime import datetime, timedelta\nfrom typing import Dict, Any, List\nfrom openai import OpenAI\nfrom google.oauth2 import service_account\nfrom googleapiclient.discovery import build\nfrom googleapiclient.http import MediaIoBaseUpload\nimport io\n\n\n# ================================================================================\n# CONFIGURATION\n# ================================================================================\n\nOPENAI_API_KEY = os.environ.get('OPENAI_API_KEY')\nGOOGLE_CREDENTIALS = json.loads(os.environ.get('GOOGLE_DRIVE_CREDENTIALS'))\nFOLDER_ID = os.environ.get('GOOGLE_DRIVE_FOLDER_ID')\n\n# Mod√®le premium pour synth√®se qualitative\nMODEL_SYNTHESE = \"gpt-4o-2024-11-20\"\n\n# Fichiers d'entr√©e/sortie\nINPUT_JSON = \"articles_filtres_news.json\"\nOUTPUT_MARKDOWN = \"VeilleNews.md\"\n\n\n# ================================================================================\n# CHARGEMENT DONN√âES FILTR√âES\n# ================================================================================\n\ndef charger_articles_filtres() -> Dict[str, Any]:\n    \"\"\"Charge le JSON produit par Agent 1\"\"\"\n    if not os.path.exists(INPUT_JSON):\n        raise FileNotFoundError(f\"‚ùå Fichier {INPUT_JSON} introuvable\")\n    \n    with open(INPUT_JSON, 'r', encoding='utf-8') as f:\n        data = json.load(f)\n    \n    print(f\"‚úÖ JSON charg√© : {len(data['articles'])} articles\")\n    return data\n\n\n# ================================================================================\n# TRI ET S√âLECTION DES ARTICLES\n# ================================================================================\n\ndef trier_articles(articles: List[Dict[str, Any]]) -> tuple:\n    \"\"\"\n    Trie les articles par pertinence et s√©pare en 2 groupes\n    Returns: (top_6, autres)\n    \"\"\"\n    # Trier par pertinence d√©croissante\n    articles_tries = sorted(articles, key=lambda x: x['pertinence'], reverse=True)\n    \n    # S√©parer\n    top_6 = articles_tries[:6]\n    autres = articles_tries[6:]\n    \n    print(f\"üìä Top 6 articles : {len(top_6)}\")\n    print(f\"üìä Autres sujets : {len(autres)}\")\n    \n    return top_6, autres\n\n\n# ================================================================================\n# G√âN√âRATION SYNTH√àSE MARKDOWN GPT-4o\n# ================================================================================\n\ndef generer_synthese_markdown(data: Dict[str, Any]) -> str:\n    \"\"\"Utilise GPT-4o pour g√©n√©rer une synth√®se Markdown avec structure 6+autres\"\"\"\n    \n    client = OpenAI(api_key=OPENAI_API_KEY)\n    \n    # Trier les articles\n    top_6, autres = trier_articles(data['articles'])\n    \n    # Pr√©parer texte TOP 6\n    top_6_text = \"\"\n    for i, art in enumerate(top_6, 1):\n        top_6_text += f\"\\n**[{i}] {art['titre']}**\\n\"\n        top_6_text += f\"Source: {art['source']} | URL: {art['url']}\\n\"\n        top_6_text += f\"Th√®me: {art['theme']}\\n\"\n        top_6_text += f\"Snippet: {art['snippet']}\\n\"\n        top_6_text += f\"Pertinence: {art['pertinence']}/10 | Tags: {', '.join(art['tags'])}\\n\\n\"\n    \n    # Pr√©parer texte AUTRES\n    autres_text = \"\"\n    for art in autres:\n        autres_text += f\"\\n**{art['titre']}**\\n\"\n        autres_text += f\"Source: {art['source']} | URL: {art['url']}\\n\"\n        autres_text += f\"Th√®me: {art['theme']}\\n\"\n        autres_text += f\"Snippet: {art['snippet'][:150]}...\\n\"\n        autres_text += f\"Pertinence: {art['pertinence']}/10\\n\\n\"\n    \n    date_debut = datetime.strptime(data['periode']['debut'], '%Y-%m-%d')\n    date_fin = datetime.strptime(data['periode']['fin'], '%Y-%m-%d')\n    \n    prompt = f\"\"\"Tu es un journaliste expert en actualit√©s fran√ßaises/internationales qui produit une veille hebdomadaire pour un cadre sup√©rieur fran√ßais, ing√©nieur, vivant √† Nantes.\n\n**P√âRIODE** : du {date_debut.strftime('%d/%m/%Y')} au {date_fin.strftime('%d/%m/%Y')}\n\n**ARTICLES PRINCIPAUX (Top 6 - traitement d√©taill√©)** :\n{top_6_text}\n\n**AUTRES ARTICLES (traitement bref)** :\n{autres_text}\n\n**STRUCTURE DU MARKDOWN √Ä G√âN√âRER** :\n\n```markdown\n---\nagent: Veille Actualit√©s (2 agents OpenAI)\ndate: {date_fin.strftime('%Y-%m-%d')}\ncat√©gorie: Actualit√©s G√©n√©rales\nmod√®les: GPT-4o-mini (collecte) + GPT-4o (synth√®se)\n---\n\n# Veille hebdomadaire ‚Äì Semaine du {date_debut.strftime('%d/%m/%Y')} au {date_fin.strftime('%d/%m/%Y')}\n\n**√âdition [Nom cr√©atif sobre]**\n\n---\n\n## Introduction\n\n[4-5 lignes : ambiance g√©n√©rale, tendances, tensions, climat m√©diatique]\n\n---\n\n## [SUJET 1/6] ‚Äì [Titre accrocheur]\n\n### R√©sum√©\n[5 lignes max : faits essentiels, enjeux, impacts]\n\n### Points de vue des m√©dias\n\n**[M√©dia 1]**\n[Angle √©ditorial, ton, analyse, 3-4 lignes]\n\n**[M√©dia 2]**\n[Divergences, critiques, 3-4 lignes]\n\n**[M√©dia 3]** (si disponible)\n[Analyse compl√©mentaire, 3-4 lignes]\n\n### Implications\n- Politiques : [...]\n- √âconomiques : [...]\n- Sociales : [...]\n- Environnementales : [...]\n\n### Sources\n- [Titre] ‚Äì [URL compl√®te]\n\n---\n\n[R√âP√âTER POUR SUJETS 2, 3, 4, 5, 6]\n\n---\n\n## Autres sujets de la semaine\n\n### [Titre court sujet A]\n**Th√®me** : [Th√®me]\n**R√©sum√©** : [2-3 lignes]\n**Source** : [Nom m√©dia] ‚Äì [URL]\n\n### [Titre court sujet B]\n**Th√®me** : [Th√®me]\n**R√©sum√©** : [2-3 lignes]\n**Source** : [Nom m√©dia] ‚Äì [URL]\n\n[Continuer pour tous les autres articles]\n\n---\n\n## Synth√®se finale\n\n### √âv√©nements majeurs\n1. [Point 1]\n2. [Point 2]\n3. [Point 3]\n\n### Divergences √©ditoriales cl√©s\n- [Diff√©rences d'interpr√©tation entre m√©dias]\n\n### Implications possibles\n- Politiques : [...]\n- √âconomiques : [...]\n- Sociales : [...]\n- Environnementales : [...]\n\n### √Ä surveiller la semaine prochaine\n- [Sujet 1]\n- [Sujet 2]\n\n---\n\n**Fin de l'√©dition**\n*Veille g√©n√©r√©e automatiquement par syst√®me 2-agents OpenAI*\n```\n\n**CONSIGNES CRITIQUES** :\n\n1. **Top 6** : Traitement COMPLET avec r√©sum√©, points de vue m√©dias, implications, sources\n2. **Autres sujets** : Format BREF avec th√®me, r√©sum√© court (2-3 lignes), source unique\n3. **Style** : Sobre, professionnel, √©l√©gant, pas d'emoji\n4. **Sources** : URLs compl√®tes obligatoires\n5. **Reformulation** : Jamais de copier-coller\n6. **Neutralit√© stricte** : Pr√©senter faits sans jugement\n7. **√âquilibre** : Top 6 = 80% du contenu, Autres = 20%\n\n**IMPORTANT** :\n- Les 6 premiers sujets doivent √™tre ultra-d√©taill√©s\n- Les autres sujets sont juste list√©s pour tra√ßabilit√©\n- Maintenir coh√©rence narrative\n\nG√©n√®re le Markdown complet maintenant, sans pr√©ambule.\"\"\"\n\n    print(\"ü§ñ G√©n√©ration synth√®se Markdown avec GPT-4o...\")\n    \n    try:\n        response = client.chat.completions.create(\n            model=MODEL_SYNTHESE,\n            messages=[\n                {\n                    \"role\": \"system\",\n                    \"content\": \"Tu es un journaliste expert en actualit√©s. Tu r√©ponds UNIQUEMENT en Markdown, sans pr√©ambule.\"\n                },\n                {\n                    \"role\": \"user\",\n                    \"content\": prompt\n                }\n            ],\n            temperature=0.7,\n            max_tokens=6000\n        )\n        \n        markdown_content = response.choices[0].message.content.strip()\n        \n        print(f\"üìä Tokens utilis√©s : {response.usage.total_tokens}\")\n        \n        cost_input = (response.usage.prompt_tokens / 1000) * 0.03\n        cost_output = (response.usage.completion_tokens / 1000) * 0.06\n        cost_total = cost_input + cost_output\n        print(f\"üí∞ Co√ªt estim√© : ${cost_total:.4f}\")\n        \n        print(f\"‚úÖ Synth√®se g√©n√©r√©e : {len(markdown_content)} caract√®res\")\n        \n        return markdown_content\n    \n    except Exception as e:\n        print(f\"‚ùå Erreur GPT-4o : {e}\")\n        traceback.print_exc()\n        raise\n\n\n# ================================================================================\n# UPLOAD GOOGLE DRIVE\n# ================================================================================\n\ndef uploader_vers_drive(contenu_markdown: str) -> None:\n    \"\"\"Upload vers Google Drive\"\"\"\n    \n    print(\"‚òÅÔ∏è  Upload vers Google Drive...\")\n    \n    credentials = service_account.Credentials.from_service_account_info(\n        GOOGLE_CREDENTIALS,\n        scopes=['https://www.googleapis.com/auth/drive']\n    )\n    \n    service = build('drive', 'v3', credentials=credentials)\n    \n    query = f\"name='{OUTPUT_MARKDOWN}' and '{FOLDER_ID}' in parents\"\n    results = service.files().list(q=query, fields=\"files(id, name)\").execute()\n    files = results.get('files', [])\n    \n    file_metadata = {'name': OUTPUT_MARKDOWN}\n    media = MediaIoBaseUpload(\n        io.BytesIO(contenu_markdown.encode('utf-8')),\n        mimetype='text/markdown',\n        resumable=True\n    )\n    \n    if files:\n        file_id = files[0]['id']\n        service.files().update(\n            fileId=file_id,\n            media_body=media\n        ).execute()\n        print(f\"‚úÖ Fichier {OUTPUT_MARKDOWN} mis √† jour sur Google Drive\")\n    else:\n        file_metadata['parents'] = [FOLDER_ID]\n        service.files().create(\n            body=file_metadata,\n            media_body=media,\n            fields='id'\n        ).execute()\n        print(f\"‚úÖ Fichier {OUTPUT_MARKDOWN} cr√©√© sur Google Drive\")\n\n\n# ================================================================================\n# MAIN\n# ================================================================================\n\ndef main():\n    \"\"\"Point d'entr√©e principal\"\"\"\n    \n    try:\n        print(\"=\" * 80)\n        print(\"ü§ñ AGENT 2 - SYNTH√âTISEUR NEWS (GPT-4o)\")\n        print(\"=\" * 80)\n        print(f\"‚è∞ Ex√©cution : {datetime.now().strftime('%d/%m/%Y %H:%M:%S')}\")\n        print()\n        \n        if not OPENAI_API_KEY:\n            print(\"‚ùå OPENAI_API_KEY manquante\")\n            sys.exit(1)\n        \n        if not GOOGLE_CREDENTIALS:\n            print(\"‚ùå GOOGLE_DRIVE_CREDENTIALS manquantes\")\n            sys.exit(1)\n        \n        print(\"üìÇ √âTAPE 1/3 : Chargement JSON filtr√©\")\n        print(\"-\" * 80)\n        data = charger_articles_filtres()\n        print()\n        \n        print(\"üìù √âTAPE 2/3 : G√©n√©ration synth√®se (6 d√©taill√©s + autres)\")\n        print(\"-\" * 80)\n        synthese = generer_synthese_markdown(data)\n        print()\n        \n        print(\"‚òÅÔ∏è  √âTAPE 3/3 : Upload Google Drive\")\n        print(\"-\" * 80)\n        uploader_vers_drive(synthese)\n        print()\n        \n        print(\"=\" * 80)\n        print(\"‚úÖ AGENT 2 NEWS TERMIN√â AVEC SUCC√àS\")\n        print(\"=\" * 80)\n        print(f\"üìä {len(data['articles'])} articles synth√©tis√©s\")\n        print(f\"‚òÅÔ∏è  Fichier : {OUTPUT_MARKDOWN}\")\n        print()\n        \n        sys.exit(0)\n    \n    except Exception as e:\n        print(\"\\n\" + \"=\" * 80)\n        print(\"‚ùå ERREUR FATALE\")\n        print(\"=\" * 80)\n        print(f\"Type : {type(e).__name__}\")\n        print(f\"Message : {e}\")\n        traceback.print_exc()\n        print(\"=\" * 80)\n        sys.exit(1)\n\n\nif __name__ == \"__main__\":\n    main()\n