name: Deep Research Quotidien

on:
  schedule:
    # Tous les jours Ã  6h00 Paris (5h00 UTC en hiver, 4h00 UTC en Ã©tÃ©)
    - cron: '0 5 * * *'
  workflow_dispatch:  # Permet dÃ©clenchement manuel

jobs:
  # ==================================================================================
  # JOB 1 : DEEP RESEARCH IA
  # ==================================================================================
  deep-research-ia:
    name: ğŸ”¬ Deep Research IA
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout pour recherche longue
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai
      
      - name: ğŸ” Execute Deep Research IA
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python agents/deep_research_ia.py
      
      - name: ğŸ“¤ Upload research_ia.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: research-ia
          path: research_ia.md
          retention-days: 1
  
  # ==================================================================================
  # JOB 2 : DEEP RESEARCH NEWS
  # ==================================================================================
  deep-research-news:
    name: ğŸ“° Deep Research News
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai
      
      - name: ğŸ” Execute Deep Research News
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python agents/deep_research_news.py
      
      - name: ğŸ“¤ Upload research_news.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: research-news
          path: research_news.md
          retention-days: 1
  
  # ==================================================================================
  # JOB 3 : FORMATTER ET UPLOAD
  # ==================================================================================
  formatter-and-upload:
    name: ğŸ“ Mise en forme et Upload
    runs-on: ubuntu-latest
    needs: [deep-research-ia, deep-research-news]  # Attend les 2 recherches
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: ğŸ“¥ Download research_ia.md
        uses: actions/download-artifact@v4
        with:
          name: research-ia
      
      - name: ğŸ“¥ Download research_news.md
        uses: actions/download-artifact@v4
        with:
          name: research-news
      
      - name: ğŸ“ Execute Formatter
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python agents/agent_formatter.py
      
      - name: âœ… Job completed
        run: |
          echo "âœ… Deep Research terminÃ© avec succÃ¨s"
          echo "ğŸ“„ VeilleIA.md et VeilleNews.md uploadÃ©s sur Google Drive"
