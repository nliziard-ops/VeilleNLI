name: Deep Research Quotidien

on:
  schedule:
    # Tous les jours Ã  6h00 Paris (5h00 UTC en hiver, 4h00 UTC en Ã©tÃ©)
    - cron: '0 5 * * *'
  workflow_dispatch:  # Permet dÃ©clenchement manuel

jobs:
  # ==================================================================================
  # JOB 1 : DEEP RESEARCH IA
  # ==================================================================================
  deep-research-ia:
    name: ğŸ”¬ Deep Research IA
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout pour recherche longue
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai
      
      - name: ğŸ” Execute Deep Research IA
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python agents/deep_research_ia.py
      
      - name: ğŸ“¤ Upload research_ia.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: research-ia
          path: research_ia.md
          retention-days: 1
  
  # ==================================================================================
  # JOB 2 : DEEP RESEARCH NEWS
  # ==================================================================================
  deep-research-news:
    name: ğŸ“° Deep Research News
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai
      
      - name: ğŸ” Execute Deep Research News
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python agents/deep_research_news.py
      
      - name: ğŸ“¤ Upload research_news.md artifact
        uses: actions/upload-artifact@v4
        with:
          name: research-news
          path: research_news.md
          retention-days: 1
  
  # ==================================================================================
  # JOB 3 : FORMATTER ET UPLOAD GOOGLE DRIVE
  # ==================================================================================
  formatter-and-upload:
    name: ğŸ“ Mise en forme et Upload
    runs-on: ubuntu-latest
    needs: [deep-research-ia, deep-research-news]  # Attend les 2 recherches
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install openai google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: ğŸ“¥ Download research_ia.md
        uses: actions/download-artifact@v4
        with:
          name: research-ia
      
      - name: ğŸ“¥ Download research_news.md
        uses: actions/download-artifact@v4
        with:
          name: research-news
      
      - name: ğŸ“ Execute Formatter
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python agents/agent_formatter.py
      
      - name: âœ… Upload completed
        run: |
          echo "âœ… VeilleIA.md et VeilleNews.md uploadÃ©s sur Google Drive"

  # ==================================================================================
  # JOB 4 : SYNC MARKDOWN â†’ GITHUB
  # ==================================================================================
  sync-markdown-to-github:
    name: ğŸ“‚ Sync Markdown â†’ GitHub
    runs-on: ubuntu-latest
    needs: formatter-and-upload
    timeout-minutes: 5
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install google-api-python-client google-auth
      
      - name: â¬‡ï¸ Download Markdown from Google Drive
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python - <<'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          credentials = service_account.Credentials.from_service_account_info(
              json.loads(os.environ['GOOGLE_DRIVE_CREDENTIALS']),
              scopes=['https://www.googleapis.com/auth/drive.readonly']
          )
          service = build('drive', 'v3', credentials=credentials)
          folder_id = os.environ['GOOGLE_DRIVE_FOLDER_ID']

          for filename in ['VeilleIA.md', 'VeilleNews.md']:
              query = f"name='{filename}' and '{folder_id}' in parents"
              results = service.files().list(q=query, fields="files(id, name)").execute()
              files = results.get('files', [])
              
              if files:
                  file_id = files[0]['id']
                  request = service.files().get_media(fileId=file_id)
                  fh = io.BytesIO()
                  downloader = MediaIoBaseDownload(fh, request)
                  done = False
                  while not done:
                      _, done = downloader.next_chunk()
                  
                  os.makedirs('docs/markdown', exist_ok=True)
                  with open(f'docs/markdown/{filename}', 'wb') as f:
                      f.write(fh.getvalue())
                  print(f"âœ… {filename} tÃ©lÃ©chargÃ©")
              else:
                  print(f"âš ï¸  {filename} introuvable")
          EOF
      
      - name: ğŸ’¾ Commit Markdown files
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/markdown/*.md
          
          if git diff --staged --quiet; then
            echo "âœ… Aucun changement Ã  commiter"
          else
            git commit -m "ğŸ“‹ Sync Markdown depuis Google Drive [Deep Research]"
            
            # Retry logic avec gestion des conflits
            for i in {1..3}; do
              git pull --rebase -X ours origin main && git push && break || {
                echo "âš ï¸  Tentative $i Ã©chouÃ©e, retry..."
                sleep 2
              }
            done
          fi

  # ==================================================================================
  # JOB 5 : GÃ‰NÃ‰RATION DATA.JSON
  # ==================================================================================
  generate-data-json:
    name: ğŸ“Š GÃ©nÃ©ration data.json
    runs-on: ubuntu-latest
    needs: sync-markdown-to-github
    timeout-minutes: 5
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: ğŸ”¨ Generate data.json
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "ğŸš€ GÃ©nÃ©ration de data.json..."
          python agents/agent_generateur_json.py
          echo "âœ… data.json gÃ©nÃ©rÃ©"
          ls -lh docs/data.json
      
      - name: ğŸ’¾ Commit data.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet docs/data.json; then
            echo "â„¹ï¸ Aucune modification dans data.json"
            exit 0
          fi
          
          git add docs/data.json
          git commit -m "ğŸ“Š Mise Ã  jour data.json [Deep Research] - $(date '+%Y-%m-%d %H:%M')"
          
          # Push avec retry et gestion conflits
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "ğŸ”„ Tentative de push ($((retry_count + 1))/$max_retries)..."
            
            git rebase --abort 2>/dev/null || true
            git merge --abort 2>/dev/null || true
            
            if git pull --rebase -X ours origin main; then
              if git push origin main; then
                echo "âœ… data.json pushÃ© avec succÃ¨s"
                exit 0
              fi
            fi
            
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              sleep 5
            fi
          done
          
          echo "âŒ Ã‰chec du push aprÃ¨s $max_retries tentatives"
          exit 1

  # ==================================================================================
  # JOB 6 : RÃ‰SUMÃ‰ FINAL
  # ==================================================================================
  summary:
    name: âœ… RÃ©sumÃ© final
    runs-on: ubuntu-latest
    needs: generate-data-json
    if: always()
    
    steps:
      - name: ğŸ“Š Workflow Summary
        run: |
          echo "=========================================="
          echo "âœ… DEEP RESEARCH QUOTIDIEN TERMINÃ‰"
          echo "=========================================="
          echo ""
          echo "ğŸ“Š Pipeline exÃ©cutÃ© :"
          echo "  1 â†’ Deep Research IA (o1)"
          echo "  2 â†’ Deep Research News (o1)"
          echo "  3 â†’ Formatter + Upload (GPT-4o-mini)"
          echo "  4 â†’ Sync Markdown â†’ GitHub"
          echo "  5 â†’ GÃ©nÃ©ration data.json"
          echo "  6 â†’ RÃ©sumÃ© final"
          echo ""
          echo "ğŸ“„ Fichiers gÃ©nÃ©rÃ©s :"
          echo "  â˜ï¸  VeilleIA.md (Google Drive)"
          echo "  â˜ï¸  VeilleNews.md (Google Drive)"
          echo "  ğŸ“ docs/markdown/*.md (GitHub)"
          echo "  ğŸ“Š docs/data.json (GitHub)"
          echo ""
          echo "ğŸŒ Site mis Ã  jour :"
          echo "  https://nliziard-ops.github.io/VeilleNLI/"
          echo ""
          echo "â° Prochaine exÃ©cution : demain 6h00 Paris"
          echo "=========================================="
