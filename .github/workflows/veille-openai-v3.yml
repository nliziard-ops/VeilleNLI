name: ğŸ¤– Veille OpenAI v3 - Architecture SÃ©parÃ©e (Collecte | SynthÃ¨se)

# Pipeline 4-agents OpenAI : Recherche PURE + SynthÃ¨se COMPLÃˆTE
# Architecture : Recherche IA â†’ SynthÃ¨se IA | Recherche News â†’ SynthÃ¨se News â†’ Sync + Site
# Version 3 : SÃ©paration stricte collecte/analyse

# on:
#  schedule:
#    - cron: '0 6 * * 0,1,3,6'  # Lundi, Mercredi, Samedi, Dimanche Ã  6h00 Paris
#  workflow_dispatch:  # DÃ©clenchement manuel

#env:
 # TZ: Europe/Paris

jobs:
  # ============================================
  # Ã‰TAPE 1.1 : RECHERCHE IA v3 (parallÃ¨le avec 2.1)
  # ============================================
  step-1-1-recherche-ia:
    name: "1.1 - Recherche IA v3 (GPT-5.2, 10k tokens)"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸš€ Run Recherche IA v3
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ” Lancement Agent Recherche IA v3 (collecte PURE)..."
          python agents/agent_recherche_ia_v3.py
      
      - name: ğŸ“¤ Upload JSON brut (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: recherche-ia-brute
          path: recherche_ia_brute.json
          retention-days: 1

  # ============================================
  # Ã‰TAPE 1.2 : SYNTHÃˆSE IA v3 (attend 1.1)
  # ============================================
  step-1-2-synthese-ia:
    name: "1.2 - SynthÃ¨se IA v3 (GPT-5.2 Pro, 8k tokens)"
    runs-on: ubuntu-latest
    needs: step-1-1-recherche-ia
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“¥ Download JSON brut IA
        uses: actions/download-artifact@v4
        with:
          name: recherche-ia-brute
          path: .
      
      - name: ğŸš€ Run SynthÃ¨se IA v3
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "ğŸ“ Lancement Agent SynthÃ¨se IA v3 (analyse COMPLÃˆTE)..."
          python agents/agent_synthese_ia_v3.py
          echo "âœ… VeilleIA.md uploadÃ© sur Google Drive"

  # ============================================
  # Ã‰TAPE 2.1 : RECHERCHE NEWS v3 (parallÃ¨le avec 1.1)
  # ============================================
  step-2-1-recherche-news:
    name: "2.1 - Recherche News v3 (GPT-5.2, 10k tokens)"
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸš€ Run Recherche News v3
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "ğŸ” Lancement Agent Recherche News v3 (collecte PURE)..."
          python agents/agent_recherche_news_v3.py
      
      - name: ğŸ“¤ Upload JSON brut (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: recherche-news-brute
          path: recherche_news_brute.json
          retention-days: 1

  # ============================================
  # Ã‰TAPE 2.2 : SYNTHÃˆSE NEWS v3 (attend 2.1)
  # ============================================
  step-2-2-synthese-news:
    name: "2.2 - SynthÃ¨se News v3 (GPT-5.2 Pro, 8k tokens)"
    runs-on: ubuntu-latest
    needs: step-2-1-recherche-news
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: ğŸ“¥ Download JSON brut News
        uses: actions/download-artifact@v4
        with:
          name: recherche-news-brute
          path: .
      
      - name: ğŸš€ Run SynthÃ¨se News v3
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "ğŸ“ Lancement Agent SynthÃ¨se News v3 (analyse COMPLÃˆTE)..."
          python agents/agent_synthese_news_v3.py
          echo "âœ… VeilleNews.md uploadÃ© sur Google Drive"

  # ============================================
  # Ã‰TAPE 3 : VALIDATION (attend 1.2 ET 2.2)
  # ============================================
  step-3-validation-markdown:
    name: "3 - Validation Markdown"
    runs-on: ubuntu-latest
    needs: [step-1-2-synthese-ia, step-2-2-synthese-news]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install google-api-python-client google-auth
      
      - name: ğŸ” Validate Markdown files
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "ğŸ” Validation des fichiers Markdown..."
          python agents/agent_validateur_markdown.py
          echo "âœ… VeilleIA.md et VeilleNews.md validÃ©s"

  # ============================================
  # Ã‰TAPE 4 : SYNC MARKDOWN â†’ GITHUB (attend 3)
  # ============================================
  step-4-sync-markdown:
    name: "4 - Sync Markdown â†’ GitHub"
    runs-on: ubuntu-latest
    needs: step-3-validation-markdown
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install google-api-python-client google-auth
      
      - name: â¬‡ï¸ Download from Google Drive
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python - <<'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          credentials = service_account.Credentials.from_service_account_info(
              json.loads(os.environ['GOOGLE_DRIVE_CREDENTIALS']),
              scopes=['https://www.googleapis.com/auth/drive.readonly']
          )
          service = build('drive', 'v3', credentials=credentials)
          folder_id = os.environ['GOOGLE_DRIVE_FOLDER_ID']

          for filename in ['VeilleIA.md', 'VeilleNews.md']:
              query = f"name='{filename}' and '{folder_id}' in parents"
              results = service.files().list(q=query, fields="files(id)").execute()
              files = results.get('files', [])
              
              if files:
                  file_id = files[0]['id']
                  request = service.files().get_media(fileId=file_id)
                  fh = io.BytesIO()
                  downloader = MediaIoBaseDownload(fh, request)
                  done = False
                  while not done:
                      _, done = downloader.next_chunk()
                  
                  os.makedirs('docs/markdown', exist_ok=True)
                  with open(f'docs/markdown/{filename}', 'wb') as f:
                      f.write(fh.getvalue())
                  print(f"âœ… {filename} tÃ©lÃ©chargÃ©")
              else:
                  print(f"âš ï¸  {filename} introuvable")
          EOF
      
      - name: ğŸ’¾ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/markdown/*.md
          
          if git diff --staged --quiet; then
            echo "âœ… Aucun changement Ã  commiter"
          else
            git commit -m "ğŸ“‹ Sync Markdown depuis Google Drive [v3]"
            
            # Retry logic avec gestion des conflits
            for i in {1..3}; do
              git pull --rebase -X ours origin main && git push && break || {
                echo "âš ï¸  Tentative $i Ã©chouÃ©e, retry..."
                sleep 2
              }
            done
          fi

  # ============================================
  # Ã‰TAPE 5 : GÃ‰NÃ‰RATION data.json (attend 4)
  # ============================================
  step-5-update-data-json:
    name: "5 - GÃ©nÃ©ration data.json"
    runs-on: ubuntu-latest
    needs: step-4-sync-markdown
    permissions:
      contents: write
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          pip install --upgrade pip
          pip install google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client
      
      - name: ğŸ”¨ GÃ©nÃ©ration de data.json
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "ğŸš€ GÃ©nÃ©ration de data.json..."
          python agents/agent_generateur_json.py
          echo "âœ… data.json gÃ©nÃ©rÃ©"
          ls -lh docs/data.json
      
      - name: ğŸ’¾ Commit and push data.json
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet docs/data.json; then
            echo "â„¹ï¸ Aucune modification dans data.json"
            exit 0
          fi
          
          git add docs/data.json
          git commit -m "ğŸ¤– Mise Ã  jour data.json v3 - $(date '+%Y-%m-%d %H:%M')"
          
          # Push avec retry
          max_retries=3
          retry_count=0
          
          while [ $retry_count -lt $max_retries ]; do
            echo "ğŸ”„ Tentative de push ($((retry_count + 1))/$max_retries)..."
            
            git rebase --abort 2>/dev/null || true
            git merge --abort 2>/dev/null || true
            
            if git pull --rebase -X ours origin main; then
              if git push origin main; then
                echo "âœ… data.json pushÃ© avec succÃ¨s"
                exit 0
              fi
            fi
            
            retry_count=$((retry_count + 1))
            if [ $retry_count -lt $max_retries ]; then
              sleep 5
            fi
          done
          
          echo "âŒ Ã‰chec du push"
          exit 1

  # ============================================
  # Ã‰TAPE 6 : RÃ‰SUMÃ‰ FINAL (attend 5)
  # ============================================
  step-6-summary:
    name: "6 - RÃ©sumÃ© final"
    runs-on: ubuntu-latest
    needs: step-5-update-data-json
    if: always()
    
    steps:
      - name: ğŸ“Š Workflow Summary
        run: |
          echo "==========================================="
          echo "âœ… VEILLE OPENAI v3 TERMINÃ‰E"
          echo "==========================================="
          echo ""
          echo "ğŸ“Š Pipeline 4-agents v3 (Collecte | SynthÃ¨se) :"
          echo "  1.1 â†’ Recherche IA v3 (GPT-5.2, 10k tokens, collecte PURE)"
          echo "  1.2 â†’ SynthÃ¨se IA v3 (GPT-5.2 Pro, 8k tokens, analyse COMPLÃˆTE)"
          echo "  2.1 â†’ Recherche News v3 (GPT-5.2, 10k tokens, collecte PURE)"
          echo "  2.2 â†’ SynthÃ¨se News v3 (GPT-5.2 Pro, 8k tokens, analyse COMPLÃˆTE)"
          echo "  3   â†’ Validation Markdown"
          echo "  4   â†’ Sync Markdown â†’ GitHub"
          echo "  5   â†’ GÃ©nÃ©ration data.json"
          echo "  6   â†’ RÃ©sumÃ© final"
          echo ""
          echo "ğŸ¯ Architecture v3 :"
          echo "  â€¢ Agents Recherche : Collecte brute (max 25 articles, 10k tokens)"
          echo "  â€¢ Agents SynthÃ¨se : Analyse Top 6 + Autres (8k tokens)"
          echo "  â€¢ IA : 3 buzz + 3 tech | News : 2 int + 2 nat + 2 local"
          echo ""
          echo "ğŸ“„ Fichiers gÃ©nÃ©rÃ©s :"
          echo "  â˜ï¸  VeilleIA.md (Google Drive)"
          echo "  â˜ï¸  VeilleNews.md (Google Drive)"
          echo "  ğŸ“ docs/markdown/*.md (GitHub)"
          echo "  ğŸ“Š docs/data.json (GitHub)"
          echo ""
          echo "ğŸŒ Site mis Ã  jour :"
          echo "  https://nliziard-ops.github.io/VeilleNLI/"
          echo ""
          echo "â° Prochaine exÃ©cution : Lundi, Mercredi, Samedi, Dimanche Ã  6h00 Paris"
          echo "==========================================="
