name: üßπ Nettoyage Repository (Manuel)

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/cleanup-repo.yml'

jobs:
  cleanup:
    name: Nettoyage des fichiers obsol√®tes
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üîç Simulation du nettoyage
        run: |
          echo "üîç Mode simulation activ√©"
          python scripts/cleanup_repository.py
      
      - name: ‚ö†Ô∏è Confirmation requise
        run: |
          echo "=================================="
          echo "‚ö†Ô∏è  ATTENTION : NETTOYAGE DESTRUCTIF"
          echo "=================================="
          echo ""
          echo "Ce workflow va supprimer d√©finitivement :"
          echo "  ‚Ä¢ 36 fichiers obsol√®tes"
          echo "  ‚Ä¢ 2 dossiers (archive/, config/)"
          echo ""
          echo "Fichiers conserv√©s :"
          echo "  ‚Ä¢ .github/workflows/veille-openai-v3.yml"
          echo "  ‚Ä¢ agents/*_v3.py (recherche + synth√®se)"
          echo "  ‚Ä¢ agents/agent_validateur_markdown.py"
          echo "  ‚Ä¢ agents/agent_generateur_json.py"
          echo "  ‚Ä¢ scripts/list_openai_models.py"
          echo "  ‚Ä¢ requirements.txt, README.md"
          echo "  ‚Ä¢ docs/ (site web)"
          echo ""
          echo "Pour continuer, validez manuellement l'√©tape suivante"
      
      - name: üóëÔ∏è Ex√©cution du nettoyage
        run: |
          echo "üóëÔ∏è Ex√©cution du nettoyage..."
          python scripts/cleanup_repository.py --execute
      
      - name: üìä V√©rification post-nettoyage
        run: |
          echo "üìä √âtat du repository apr√®s nettoyage:"
          echo ""
          echo "Workflows restants:"
          ls -lh .github/workflows/ || echo "Aucun workflow"
          echo ""
          echo "Agents restants:"
          ls -lh agents/ || echo "Aucun agent"
          echo ""
          echo "Scripts restants:"
          ls -lh scripts/ || echo "Aucun script"
      
      - name: üíæ Commit et push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Aucun fichier supprim√© (d√©j√† propre)"
          else
            git commit -m "üßπ Nettoyage automatique du repository" \
                       -m "Suppression fichiers obsol√®tes (workflows, docs, agents v1/v2)" \
                       -m "Conservation: workflow v3, agents v3, site web"
            
            git push origin main
            
            echo "‚úÖ Nettoyage termin√© et committ√©"
          fi
      
      - name: üéâ R√©sum√©
        run: |
          echo "============================================"
          echo "‚úÖ NETTOYAGE TERMIN√â"
          echo "============================================"
          echo ""
          echo "Le repository ne contient plus que :"
          echo "  ‚Ä¢ 2 workflows (veille-openai-v3.yml + cleanup-repo.yml)"
          echo "  ‚Ä¢ 6 agents Python (v3 uniquement)"
          echo "  ‚Ä¢ 2 scripts utilitaires"
          echo "  ‚Ä¢ Fichiers de base (README, requirements)"
          echo "  ‚Ä¢ Site web (docs/)"
          echo ""
          echo "üåê V√©rifiez le site :"
          echo "  https://nliziard-ops.github.io/VeilleNLI/"
          echo ""
          echo "============================================"
