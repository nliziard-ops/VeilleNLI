name: ü§ñ Veille IA OpenAI

on:
  # Ex√©cution quotidienne √† 6h Paris (5h UTC en hiver, 4h UTC en √©t√©)
  schedule:
    - cron: '0 5 * * *'  # 6h Paris (hiver)
  
  # D√©clenchement manuel
  workflow_dispatch:

jobs:
  agent-collecteur:
    name: "Agent 1 - Collecteur (GPT-4o-mini)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Debug - Check secrets availability
        run: |
          echo "üîç V√©rification des secrets..."
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY est vide ou absente"
          else
            echo "‚úÖ OPENAI_API_KEY est pr√©sente (longueur: ${#OPENAI_API_KEY})"
          fi
          if [ -z "$TAVILY_API_KEY" ]; then
            echo "‚ùå TAVILY_API_KEY est vide ou absente"
          else
            echo "‚úÖ TAVILY_API_KEY est pr√©sente (longueur: ${#TAVILY_API_KEY})"
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      
      - name: Run Agent 1 - Collecteur
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          echo "üöÄ Lancement Agent 1 - Collecteur"
          python agents/agent_collecteur_ia.py
      
      - name: Verify JSON file exists
        run: |
          echo "üìÅ V√©rification du fichier JSON..."
          ls -la articles_filtres_ia.json
          echo "üìä Taille du fichier:"
          du -h articles_filtres_ia.json
      
      - name: Upload JSON filtr√© (artifact pour Agent 2)
        uses: actions/upload-artifact@v4
        with:
          name: articles-filtres-ia
          path: articles_filtres_ia.json
          retention-days: 1

  agent-synthese:
    name: "Agent 2 - Synth√®se (GPT-4o)"
    runs-on: ubuntu-latest
    needs: agent-collecteur  # Attend que Agent 1 soit termin√©
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download JSON filtr√© (depuis Agent 1)
        uses: actions/download-artifact@v4
        with:
          name: articles-filtres-ia
          path: .
      
      - name: Verify downloaded JSON
        run: |
          echo "üìÅ V√©rification du JSON t√©l√©charg√©..."
          ls -la articles_filtres_ia.json
          echo "üìä Contenu du r√©pertoire:"
          ls -la
      
      - name: Debug - Check secrets availability
        run: |
          echo "üîç V√©rification des secrets..."
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY est vide ou absente"
          else
            echo "‚úÖ OPENAI_API_KEY est pr√©sente"
          fi
          if [ -z "$GOOGLE_DRIVE_CREDENTIALS" ]; then
            echo "‚ùå GOOGLE_DRIVE_CREDENTIALS est vide ou absente"
          else
            echo "‚úÖ GOOGLE_DRIVE_CREDENTIALS est pr√©sente (longueur: ${#GOOGLE_DRIVE_CREDENTIALS})"
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
      
      - name: Run Agent 2 - Synth√®se
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "üöÄ Lancement Agent 2 - Synth√®se"
          python agents/agent_synthese_ia.py
      
      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Pipeline 2-agents termin√© avec succ√®s"
          echo "üìä Agent 1 : Collecte + filtrage (GPT-4o-mini)"
          echo "üìù Agent 2 : Synth√®se Markdown (GPT-4o)"
          echo "‚òÅÔ∏è  Fichier VeilleIA.md upload√© sur Google Drive"
