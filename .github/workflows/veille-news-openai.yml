name: Agents Veille News - OpenAI (2 agents)

on:
  # Ex√©cution quotidienne √† 6h Paris
  schedule:
    - cron: '0 5 * * *'
  
  # D√©clenchement manuel
  workflow_dispatch:

jobs:
  agent-collecteur-news:
    name: "Agent 1 News - Collecteur (GPT-4o-mini)"
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Debug - Check secrets
        run: |
          echo "üîç V√©rification des secrets..."
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY absente"
          else
            echo "‚úÖ OPENAI_API_KEY pr√©sente"
          fi
          if [ -z "$TAVILY_API_KEY" ]; then
            echo "‚ùå TAVILY_API_KEY absente"
          else
            echo "‚úÖ TAVILY_API_KEY pr√©sente"
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
      
      - name: Run Agent 1 - Collecteur News
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: |
          echo "üöÄ Lancement Agent 1 - Collecteur News"
          python agents/agent_collecteur_news.py
      
      - name: Verify JSON exists
        run: |
          echo "üìÅ V√©rification du fichier JSON..."
          ls -la articles_filtres_news.json
          du -h articles_filtres_news.json
      
      - name: Upload JSON artifact
        uses: actions/upload-artifact@v4
        with:
          name: articles-filtres-news
          path: articles_filtres_news.json
          retention-days: 1

  agent-synthese-news:
    name: "Agent 2 News - Synth√®se (GPT-4o)"
    runs-on: ubuntu-latest
    needs: agent-collecteur-news
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Download JSON artifact
        uses: actions/download-artifact@v4
        with:
          name: articles-filtres-news
          path: .
      
      - name: Verify downloaded JSON
        run: |
          echo "üìÅ V√©rification du JSON t√©l√©charg√©..."
          ls -la articles_filtres_news.json
      
      - name: Debug - Check secrets
        run: |
          echo "üîç V√©rification des secrets..."
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ùå OPENAI_API_KEY absente"
          else
            echo "‚úÖ OPENAI_API_KEY pr√©sente"
          fi
          if [ -z "$GOOGLE_DRIVE_CREDENTIALS" ]; then
            echo "‚ùå GOOGLE_DRIVE_CREDENTIALS absente"
          else
            echo "‚úÖ GOOGLE_DRIVE_CREDENTIALS pr√©sente"
          fi
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
      
      - name: Run Agent 2 - Synth√®se News
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          echo "üöÄ Lancement Agent 2 - Synth√®se News"
          python agents/agent_synthese_news.py
      
      - name: Summary
        if: success()
        run: |
          echo "‚úÖ Pipeline 2-agents News termin√© avec succ√®s"
          echo "üìä Agent 1 : Collecte + filtrage (GPT-4o-mini)"
          echo "üìù Agent 2 : Synth√®se Markdown (GPT-4o)"
          echo "‚òÅÔ∏è  Fichier VeilleNews.md upload√© sur Google Drive"
