name: üìã Sync Markdown vers GitHub Pages

on:
  workflow_dispatch:
  # D√©clench√© apr√®s validation
  workflow_run:
    workflows: ["üîç Validation Markdown"]
    types:
      - completed
  # Aussi sur push manuel de fichiers Markdown
  push:
    paths:
      - 'docs/markdown/*.md'

env:
  TZ: Europe/Paris

jobs:
  sync:
    name: Synchroniser Markdown depuis Drive
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: üì¶ Install dependencies
        run: |
          pip install google-api-python-client google-auth
      
      - name: ‚¨áÔ∏è Download from Google Drive
        env:
          GOOGLE_DRIVE_CREDENTIALS: ${{ secrets.GOOGLE_DRIVE_CREDENTIALS }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python - <<'EOF'
          import os
          import json
          from google.oauth2 import service_account
          from googleapiclient.discovery import build
          from googleapiclient.http import MediaIoBaseDownload
          import io

          credentials = service_account.Credentials.from_service_account_info(
              json.loads(os.environ['GOOGLE_DRIVE_CREDENTIALS']),
              scopes=['https://www.googleapis.com/auth/drive.readonly']
          )
          service = build('drive', 'v3', credentials=credentials)
          folder_id = os.environ['GOOGLE_DRIVE_FOLDER_ID']

          for filename in ['VeilleIA.md', 'VeilleNews.md']:
              query = f"name='{filename}' and '{folder_id}' in parents"
              results = service.files().list(q=query, fields="files(id)").execute()
              files = results.get('files', [])
              
              if files:
                  file_id = files[0]['id']
                  request = service.files().get_media(fileId=file_id)
                  fh = io.BytesIO()
                  downloader = MediaIoBaseDownload(fh, request)
                  done = False
                  while not done:
                      _, done = downloader.next_chunk()
                  
                  with open(f'docs/markdown/{filename}', 'wb') as f:
                      f.write(fh.getvalue())
                  print(f"‚úÖ {filename} t√©l√©charg√©")
              else:
                  print(f"‚ö†Ô∏è  {filename} introuvable")
          EOF
      
      - name: üîÑ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add docs/markdown/*.md
          
          if git diff --staged --quiet; then
            echo "‚úÖ Aucun changement √† commiter"
          else
            git commit -m "üìã Sync Markdown depuis Google Drive [auto]"
            
            # Retry logic
            for i in {1..3}; do
              git pull --rebase origin main && git push && break || {
                echo "‚ö†Ô∏è  Tentative $i √©chou√©e, retry..."
                sleep 2
              }
            done
          fi
      
      - name: üìä Summary
        run: |
          echo "‚úÖ Synchronisation termin√©e"
          echo "üìÑ VeilleIA.md et VeilleNews.md disponibles pour GitHub Pages"
